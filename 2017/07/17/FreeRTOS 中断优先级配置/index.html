<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
       | 归档 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Terry">
    
    

    <meta name="description" content="#FreeRTOS 中断优先级配置  ##NVIC 基础知识  NVIC 的全称是 Nested vectored interrupt controller，即嵌套向量中断控制器。对于 M3 和 M4 内核的 MCU，每个中断的优先级都是用寄存器中的 8 位来设置的。ST的 STM32F1xx 和 F4xx 只使用了这个 8 位中的高四位[7:4]，低四位取零，这样 2^4=16，只能表示 16级">
<meta property="og:type" content="article">
<meta property="og:title" content=" | 归档">
<meta property="og:url" content="https://peachzz.github.io/2017/07/17/FreeRTOS 中断优先级配置/index.html">
<meta property="og:site_name" content="归档">
<meta property="og:description" content="#FreeRTOS 中断优先级配置  ##NVIC 基础知识  NVIC 的全称是 Nested vectored interrupt controller，即嵌套向量中断控制器。对于 M3 和 M4 内核的 MCU，每个中断的优先级都是用寄存器中的 8 位来设置的。ST的 STM32F1xx 和 F4xx 只使用了这个 8 位中的高四位[7:4]，低四位取零，这样 2^4=16，只能表示 16级">
<meta property="og:image" content="https://peachzz.github.io/2017/07/17/FreeRTOS%20中断优先级配置/20170624095708.png">
<meta property="og:updated_time" content="2017-07-16T16:38:57.381Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=" | 归档">
<meta name="twitter:description" content="#FreeRTOS 中断优先级配置  ##NVIC 基础知识  NVIC 的全称是 Nested vectored interrupt controller，即嵌套向量中断控制器。对于 M3 和 M4 内核的 MCU，每个中断的优先级都是用寄存器中的 8 位来设置的。ST的 STM32F1xx 和 F4xx 只使用了这个 8 位中的高四位[7:4]，低四位取零，这样 2^4=16，只能表示 16级">
<meta name="twitter:image" content="https://peachzz.github.io/2017/07/17/FreeRTOS%20中断优先级配置/20170624095708.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">归档</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          千里之行始于足下
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title"></h1>

    

    <div class="post-meta">
      <time datetime="2017-07-17" class="post-meta__date date">2017-07-17</time> 

      <span class="post-meta__tags tags">

          

          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>#FreeRTOS 中断优先级配置</p>
<hr>
<p>##NVIC 基础知识</p>
<ul>
<li>NVIC 的全称是 Nested vectored interrupt controller，即嵌套向量中断控制器。对于 M3 和 M4 内核的 MCU，每个中断的优先级都是用寄存器中的 8 位来设置的。ST的 STM32F1xx 和 F4xx 只使用了这个 8 位中的高四位[7:4]，低四位取零，这样 2^4=16，只能表示 16<br>级中断嵌套。<br>##使用 FreeRTOS 时如何配置外设 NVIC<ol>
<li>具有高抢占式优先级的中断可以在具有低抢占式优先级的中断服务程序执行过程中被响应，即中<br>断嵌套，或者说高抢占式优先级的中断可以抢占低抢占式优先级的中断的执行。</li>
</ol>
<ul>
<li>在抢占式优先级相同的情况下，有几个子优先级不同的中断同时到来，那么高子优先级的中断优<br>先被响应。</li>
<li>在抢占式优先级相同的情况下，如果有低子优先级中断正在执行，高子优先级的中断要等待已被<br>响应的低子优先级中断执行结束后才能得到响应，即子优先级不支持中断嵌套。</li>
<li>Reset、 NMI、 Hard Fault 优先级为负数，高于普通中断优先级，且优先级不可配置。</li>
<li>对于初学者还有一个比较纠结的问题就是系统中断（比如：PendSV，SVC，SysTick）是不是一<br>定比外部中断（比如 SPI,USART）要高，答案：不是的，它们是在同一个 NVIC 下面设置的。</li>
</ul>
</li>
<li>强烈推荐用户将 Cortex-M3 内核的 STM32F103 和 Cortex-M4 内核的 STM32F407 以及<br>STM32F429 的 NVIC 优先级分组设置为 4,即：NVIC_PriorityGroupConfig(NVIC_PriorityGroup_4);这<br>样中断优先级的管理将非常方便。 这个也是官方强烈建议的。<blockquote>
<p><strong>（注意：一旦初始化好 NVIC 的优先级分组后，切不可以在应用中再次更改。）<br>设置NVIC的优先级分组为4表示支持0-15级抢占优先级 （注意，0-15级是16个级别，包含0级），不支持子优先级。</strong><br>##FreeRTOS 配置选项中 NVIC 相关配置</p>
</blockquote>
</li>
<li>FreeRTOSConfig.h 配置文件中设置到 NVIC 中断的有如下几个选项：<br><img src="20170624095708.png" alt=""></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define configPRIO_BITS 4</div></pre></td></tr></table></figure>
<blockquote>
<p>此宏定义用于配置 STM32 的 8 位优先级设置寄存器实际使用的位数。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define configLIBRARY_LOWEST_INTERRUPT_PRIORITY 0x0f</div></pre></td></tr></table></figure>
<blockquote>
<p>此宏定义是用来配置 FreeRTOS 用到的 SysTick 中断和 PendSV 中断的优先级。在 NVIC 分组设置为<br>4 的情况下，此宏定义的范围就是 0-15，即专门配置抢占优先级。这里配置为了 0x0f，即 SysTick<br>和 PendSV 都是配置为了最低优先级，实际项目中也建议大家配置最低优先级即可。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY 0x01</div></pre></td></tr></table></figure>
<blockquote>
<p>此宏定义比较重要，定义了受 FreeRTOS 管理的最高优先级中断。简单的说就是允许用户在这个中断<br>服务程序里面调用 FreeRTOS 的 API 的最高优先级。 设置 NVIC 的优先级分组为 4 的情况下。 配置<br>configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY 为 0x01 表示用户可以在抢占式优先级为 1到 15 的中断里面调用 FreeRTOS 的 API 函数，抢占式优先级为 0 的中断里面是不允许调用的。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define configKERNEL_INTERRUPT_PRIORITY</div></pre></td></tr></table></figure>
<blockquote>
<p>宏定义 configLIBRARY_LOWEST_INTERRUPT_PRIORITY的数值经过 4bit偏移后得到一个 8bit<br>的优先级数值，即宏定义 configKERNEL_INTERRUPT_PRIORITY 的数值。这个 8bit 的数值才可以<br>实际赋值给相应中断的优先级寄存器。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define configMAX_SYSCALL_INTERRUPT_PRIORITY</div></pre></td></tr></table></figure>
<blockquote>
<p>宏定义 configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY 的数值经过 4bit 偏移后得到一<br>个 8bit 的优先级数值，即宏定义 configMAX_SYSCALL_INTERRUPT_PRIORITY 的数值。 这个数值<br>是赋值给寄存器 basepri 使用的，8bit 的数值才可以实际赋值给相应中断的优先级寄存器。<br>这里的宏定义数值赋给寄存器 basepri 后就可以实现全局的开关中断操作了。 比如：我们这里配<br>置宏定义 configLIBRARY_LOWEST_INTERRUPT_PRIORITY 是 0x01，经过 4bit 偏移后就是 0x10，<br>即 16。 调用了 FreeRTOS 的关中断后，所有优先级数值大于等于 16 的中断都会被关闭。优先级数值<br>小于 16 的中断不会被关闭，对寄存器 basepri 寄存器赋值 0，那么被关闭的中断会被打开。</p>
<p>##不受FreeRTOS管理中断的理解</p>
</blockquote>
<ul>
<li>对寄存器 basepri 我们举一个例子，帮助大家理解，比我们配置寄存器 basepri 的数值为 16，所有优先<br>级数值大于等于 16 的中断都会被关闭，优先级数值小于 16 的中断不会被关闭。 对寄存器 basepri 寄存器<br>赋值 0，那么被关闭的中断会被打开。 这个就是 FreeRTOS 开关中断的实现方案。</li>
</ul>

  </section>

  <section class="post-comments">

    <!-- 将评论系统（例如Disqus、多说、友言、畅言等）提供的代码片段粘贴在这里 -->
    
</section>


</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
